<html>
<head>
<title>Leaflet</title>
<link rel="stylesheet" href="css/leaflet.css" />
<script src="js/leaflet.js"></script>
<script src="js/MovingMarker.js"></script>
<style type="text/css">
    #map { height: 768px; width: 1024px}
</style>

</head>

<body>
<div id="map" style="width: 1024px; height: 768px"></div>
<script>
  var center = [31.91, 131.41];

  function loadMarkerPos(callback) {
    fetch('/markers?center=' + center.join(','), { cache: 'no-cache' })
      .then(response => response.json())
      .then(data => callback(data));
  }
  
  var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
  });

  var marker = null;
  var initialized = false;
  var markers = []
  var last_markers_keys = []
  var map = L.map('map').setView(center, 15);
  map.addLayer(tiles);

  setInterval(function(){
    loadMarkerPos(data => {
      Object.keys(data).forEach(id => {
        pos = data[id];
        console.log(id);
        console.log(pos);
        x = pos["latitude"];
        y = pos["longitude"];
        if (markers[id] == undefined) {
          markers[id] = L.Marker.movingMarker([[x, y]], [], {});
          markers[id].bindPopup(id).addTo(map);
        } else {
          markers[id].moveTo([x, y], 500);
        }
      });
    });
  }, 1000);
</script>

</body>
</html>
